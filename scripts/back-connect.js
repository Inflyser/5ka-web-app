// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
async function getUserLocation() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                resolve({
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                });
            },
            (err) => {
                console.error("Ð“ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚", err);
                alert("Ð“ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°");
                reject(err);
            }
        );
    });
}

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸
async function checkDelivery(lat, lon) {
    const response = await fetch("https://fiveka-web-app.onrender.com/check-delivery", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ lat, lon }),
    });

    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸");
    }

    return await response.json(); // { delivery, store_id, ... }
}


// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð°Ð´Ñ€ÐµÑ Ð¿Ð¾ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ð°Ð¼
async function getAddressByCoords(lat, lon) {
    const res = await fetch(`https://api.5ka.ru/api/v2/geo/address?lat=${lat}&lon=${lon}`);
    const data = await res.json();
    return data.address || "ÐÐ´Ñ€ÐµÑ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½";
}


// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¸ ÐºÐ»Ð¸ÐºÐµ
async function handleDeliveryCheck() {
    try {
        const coords = map.getCenter();
        const address = await getAddressByCoords(coords.lat, coords.lon);

        // ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÐ¼ Ð°Ð´Ñ€ÐµÑ
        document.getElementById("address").textContent = "Ð’Ð°Ñˆ Ð°Ð´Ñ€ÐµÑ: " + address;

        const deliveryResult = await checkDelivery(lat, lon);
        const { delivery, store_id, address: deliveryAddress } = deliveryResult;

        if (!delivery) {
            document.getElementById("status").textContent = "Ð”Ð¾ÑÑ‚Ð°Ð²ÐºÐ° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð¿Ð¾ Ð²Ð°ÑˆÐµÐ¼Ñƒ Ð°Ð´Ñ€ÐµÑÑƒ.";
            return;
        }

        document.getElementById("status").textContent = `âœ… Ð”Ð¾ÑÑ‚Ð°Ð²ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°!\nðŸª ÐœÐ°Ð³Ð°Ð·Ð¸Ð½ ID: ${store_id}\nðŸ“ ÐÐ´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸: ${deliveryAddress}`;

        // (ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹:
        const itemsRes = await fetch(`https://fiveka-web-app.onrender.com/store-items?store_id=${storeId}`);
        const items = await itemsRes.json();
        console.log("Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°:", items);

    } catch (error) {
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ°:", error.message);
        document.getElementById("status").textContent = "Ð”Ð¾ÑÑ‚Ð°Ð²ÐºÐ° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð¿Ð¾ Ð²Ð°ÑˆÐµÐ¼Ñƒ Ð°Ð´Ñ€ÐµÑÑƒ.";
    }
}

// ÐŸÑ€Ð¸Ð²ÑÐ·ÐºÐ° Ðº ÐºÐ½Ð¾Ð¿ÐºÐµ
document.addEventListener("DOMContentLoaded", () => {
    const button = document.getElementById("checkDeliveryBtn");
    if (button) {
        button.addEventListener("click", handleDeliveryCheck);
    }
});

